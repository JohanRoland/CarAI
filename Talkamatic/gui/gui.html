<!-- saved from url=(0050)file:///home/jstrike/CarAI/Talkamatic/gui/gui.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<link rel="stylesheet" type="text/css" href="style.css">
<script src="./gui_files/jquery.min.js"></script>
<script src="./gui_files/mqtt.js"></script>
<script>
  var ws = new WebSocket("ws://localhost:8888/tdm_gui");  
  var nrws = new WebSocket("ws://192.168.1.130:1880/gui");

  /*ws.onopen = function() {
    ws.send("Hello, world");
  };*/
  ws.onmessage = function (evt) {
    msg = JSON.parse(evt.data);
    console.log(JSON.stringify(msg,null,2));
    if(msg.length != 0)
    {
      for(var i in msg)
      {
        if("DeviceResult" in msg[i])
        {
          console.log("Action: "+ msg[i].DeviceResult.action)
        }
        if("Popup" in msg[i])
        {
          extra = "";
          m = msg[i].Popup.title.replace('-','');
          if(m != "")
          {
              if(msg[i].Popup.elements.length >0)
            {
              for(var j in msg[i].Popup.elements[0].Element.items)
              {
                extra += parseElement( msg[i].Popup.elements[0].Element.items[j]);
              }
            }
            $(".dialogue").prepend("<div class=\"convo\"><p>"+m+"</p>"+extra+"</div>");
          }
        }
        if("Screen" in msg[i])
        {
          extra = "";
          m = msg[i].Screen.title;
          if(msg[i].Screen.elements.length >0)
          {
            for(var j in msg[i].Screen.elements[0].Element.items)
            {
              extra += parseElement( msg[i].Screen.elements[0].Element.items[j]);
            }
          }
          $(".dialogue").prepend("<div class=\"convo\"><p>"+m+"</p>"+extra+"</div>");
          
        }
      }
    }
  };
  
  function parseElement(e)
  {
      if(e.Item.title != null)
      {
        return  "<button onclick=\"sendListToTDM('"+e.Item.value+"')\">"+e.Item.title+"</button>";
      }
    
  }

  function printMsg(s) {
    $(".dialogue").prepend("<div class=\"convo2\"><p>"+s+"</p></div>") 
  }

  function sendToTDM(m) {
    ws.send("[{\"InputFromGui\":{\"type\":\"text\",\"name\":\"text\",\"value\":\""+m+"\",\"title\":\"text\"}}]")
  };

  function sendListToTDM(m) {
    ws.send("[{\"InputFromGui\":{\"type\":\"list\",\"name\":\"move\",\"value\":\""+m+"\",\"title\":\"text\"}}]")
  };


  function sendUtteranceToTDM(m) {
    waitForSocketConnection(nrws,function() {
    console.log("sent message");
    nrws.send(m);
    });
    
    //ws.send("[{\"content\":[{\"score\":1,\"utterance\":\"Flingor\"}],\"event_type\":\"RECOGNITION\",\"_sender\":\"Frontend\",\"_reason\":null}]");
  };
  function waitForSocketConnection(socket, callback){
    setTimeout(
        function () {
            if (socket.readyState === 1) {
                console.log("Connection is made")
                if(callback != null){
                    callback();
                }
                return;

            } else {
                console.log("wait for connection...")
                waitForSocketConnection(socket, callback);
            }

        }, 5); // wait 5 milisecond for the connection...
  }

  function connect()
  {
    ws = new WebSocket("ws://localhost:8888/tdm_gui");
  };
  function disconnect() {
    ws.send("[{\"Disconnect\":{}}]")
  };
  function cancel() {
    ws.send("[{\"InputFromGui\":{\"type\":\"key\",\"name\":\"cancel\",\"value\":\"cancel\",\"title\":\"text\"}}]") 
  }

  function getLoc()
  {
    printMsg("Where are we?")
    sendListToTDM('ask(?X.gpsdata(X))')
  }
  
  function getDest()
  {
    printMsg("Where are we going?")
    sendListToTDM('ask(?X.destdata(X))')
  }
  
  function getEta()
  {
    printMsg("When will we arive?")
    sendListToTDM('ask(?X.timetodest(X))')
  }
  
  function getMeeting()
  {
    printMsg("What is my next scheduled event?")
    sendListToTDM('ask(?X.next_cal_event(X))')
  }
  
  $(function() {
   $("#iform").submit(function(e) {
      e.preventDefault();   
      var s = document.forms["inform"]["in"].value;
      printMsg(s);
      sendUtteranceToTDM(s);
      document.forms["inform"]["in"].value = "";
    }); 
  });
</script></head>

  <body><div class="container">
  <h1 class="sheader">CARAI</h1>
  <div class="buttons">
    <button onclick="connect()">Connect</button>
    <button onclick="disconnect()">DC</button>
    <button onclick="cancel()">Cancel</button>
  </div>
  <div class="ptt">
    <button id="pttbutton">PUSH TO TALK</button> 
  </div>
  <div class="inputbox">
    <form id="iform" name="inform">
      <input type="text" name="in" autocomplete="off">
      <input type="submit" value="Submit">
    </form>
  </div>
  <div class="quickcmd">
    <p>Quick commands:</p>
    <button onclick="getLoc()">Where Are We?</button>
    <button onclick="getDest()">Where Are We Going?</button>
    <button onclick="getEta()">ETA?</button>
    <button onclick="getMeeting()">Meeting?</button>
  </div>
  <div class="dialogue">
    <!--<div class="convo" style="display:none"></div>-->
  </div>
</div>



</body></html>
